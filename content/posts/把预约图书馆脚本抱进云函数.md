---
title: "把预约图书馆脚本抱进云函数"
date: 2022-03-17T22:50:10+08:00
draft: false
tags: ["python"]
toc: true
layout: "search"
---

## 一、代码

```python
# -*- coding: utf8 -*-
import json
import requests
import re
import datetime

session = requests.session()
sid = 221   # 座位号
email = "email@email.com" # 通知邮箱地址
username = "帐号" # 帐号密码
password = "密码"


# 获取起止时间字典
def getTime(st: int, et: int) -> any:
    st = '0' + str(st) if st < 10 else st
    et = '0' + str(et) if et < 10 else et
    return {
        'st': f'{st}:00',
        'et': f'{et}:00'
    }


# 获取提交数据
def getDateTimeSection() -> any:
    # 配置预约时间
    times = [getTime(9, 21), getTime(14, 21), getTime(14, 21), getTime(9, 21), getTime(17, 21),
             getTime(9, 21), getTime(9, 21)]
    tomorrow = (datetime.datetime.now() + datetime.timedelta(days=+1))
    week = tomorrow.weekday()
    at_date = tomorrow.strftime("%Y-%m-%d")
    return {
        'atDate': at_date,
        'st': at_date + ' ' + times[week].get('st'),
        'et': at_date + ' ' + times[week].get('et'),
        'sid': sid,
    }


# 获取登陆页面内容
def getLoginPageContent() -> str:
    return session.get('https://libzwxt.ahnu.edu.cn/SeatWx/login.aspx').text


# 获取登陆所需字段
def getLoginPostData(login_page_content: str) -> dict:
    login_post_data = {
        'Button1': '登 录  ',
        'hfurl': ''
    }
    params_name_list = ['__VIEWSTATE', '__VIEWSTATEGENERATOR', '__EVENTVALIDATION']
    for param_name in params_name_list:
        param_regex = re.compile(rf'id=\"{param_name}\" value=\".+\"')
        ret = param_regex.search(login_page_content)
        param_value = ret.group()
        login_post_data[param_name] = param_value.split("\"")[3]

    return login_post_data


# 登陆
def login(tb_user_name: str, tb_pass_word: str) -> None:
    login_page_content = getLoginPageContent()
    login_post_data = getLoginPostData(login_page_content)
    login_post_data["tbUserName"] = tb_user_name
    login_post_data["tbPassWord"] = tb_pass_word
    ret = session.post('https://libzwxt.ahnu.edu.cn/SeatWx/login.aspx', login_post_data).text


# 预约
def reserve() -> None:
    reserve_post_data = getDateTimeSection()
    header = {
        # 设定报文头
        'Host': 'libzwxt.ahnu.edu.cn',
        'Origin': 'http://libzwxt.ahnu.edu.cn',
        'Referer': 'http://libzwxt.ahnu.edu.cn/SeatWx/Seat.aspx?fid=3&sid=1438',
        'User-Agent': "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3683.86 Safari/537.36",
        'X-AjaxPro-Method': 'AddOrder',
    }
    ret = session.post('https://libzwxt.ahnu.edu.cn/SeatWx/ajaxpro/SeatManage.Seat,SeatManage.ashx',
                       data=json.dumps(reserve_post_data), headers=header).text
    sendEmail(ret)


def sendEmail(message: str) -> str:
    print(message)
    data = {
        'receiver': email,
        'title': '图书馆预约通知',
        'content': message
    }
    print('发送邮件...')
    ret = requests.post('http://api.mayapony.site/mailer', data=data).text
    return ret


def run():
    print('开始预约！')
    # noinspection PyBroadException
    try:
        login(username, password)
        print('登陆成功，正在预定...')
        reserve()
    except Exception as e:
        sendEmail('出错！')
    print('执行完毕！')


if __name__ == '__main__':
    run()

def main_handler(event, context):
    run()
```

## 二、代码放到腾讯云函数

### 1. 新建云函数

建议区域选择上海
![](/images/图书馆脚本云函数/2022-03-17_22-59.png)

### 2. 放入代码

python版本选择3.6，因为腾讯云函数对3.6版本支持比较好，提供常用的包 **（本代码所需的都有）**。并且提供更好用的在线编辑器。
![](/images/图书馆脚本云函数/2022-03-17_23-00.png)

然后把代码粘贴进编辑器
![](/images/图书馆脚本云函数/2022-03-17_23-01.png)

### 设置触发器
![](/images/图书馆脚本云函数/2022-03-17_23-02.png)

最后点完成就行了。
